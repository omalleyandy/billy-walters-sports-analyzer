name: ESPN Weekly Data Collection

on:
  # Scheduled: Weekly (Tuesday, 9 AM UTC = 1 AM PST / 4 AM EST)
  schedule:
    - cron: '0 9 * * 2'  # Tuesday 9 AM UTC
    - cron: '0 9 * * 5'  # Friday 9 AM UTC (secondary refresh)

  # Manual trigger
  workflow_dispatch:
    inputs:
      league:
        description: 'League to collect (nfl or ncaaf)'
        required: true
        default: 'ncaaf'
        type: choice
        options:
          - nfl
          - ncaaf
      week:
        description: 'Week number (optional)'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  # ========================================================================
  # Step 1: Collect NCAAF Data
  # ========================================================================
  collect-ncaaf:
    name: Collect NCAAF Data
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.11']
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs.league == 'ncaaf')
    outputs:
      session-id: ${{ steps.collect.outputs.session-id }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync --all-extras --dev

      - name: Collect NCAAF Data
        id: collect
        run: |
          SESSION_ID=$(python -c "from datetime import datetime; print(datetime.now().strftime('%Y%m%d_%H%M%S'))")
          echo "session-id=$SESSION_ID" >> $GITHUB_OUTPUT
          uv run python scripts/dev/espn_production_orchestrator.py --league ncaaf
        env:
          PYTHONUNBUFFERED: 1

      - name: Upload metrics
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ncaaf-metrics-${{ steps.collect.outputs.session-id }}
          path: data/metrics/logs/
          retention-days: 30

      - name: Upload raw data archive
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ncaaf-raw-archive-${{ steps.collect.outputs.session-id }}
          path: data/archive/raw/ncaaf/
          retention-days: 90

  # ========================================================================
  # Step 2: Collect NFL Data
  # ========================================================================
  collect-nfl:
    name: Collect NFL Data
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.11']
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs.league == 'nfl')
    outputs:
      session-id: ${{ steps.collect.outputs.session-id }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync --all-extras --dev

      - name: Collect NFL Data
        id: collect
        run: |
          SESSION_ID=$(python -c "from datetime import datetime; print(datetime.now().strftime('%Y%m%d_%H%M%S'))")
          echo "session-id=$SESSION_ID" >> $GITHUB_OUTPUT
          uv run python scripts/dev/espn_production_orchestrator.py --league nfl
        env:
          PYTHONUNBUFFERED: 1

      - name: Upload metrics
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nfl-metrics-${{ steps.collect.outputs.session-id }}
          path: data/metrics/logs/
          retention-days: 30

      - name: Upload raw data archive
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nfl-raw-archive-${{ steps.collect.outputs.session-id }}
          path: data/archive/raw/nfl/
          retention-days: 90

  # ========================================================================
  # Step 3: Monitor Quality
  # ========================================================================
  monitor-quality:
    name: Monitor Data Quality
    runs-on: ubuntu-latest
    needs: [collect-ncaaf, collect-nfl]
    if: always()
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Install dependencies
        run: uv sync --all-extras --dev

      - name: Download all metrics
        uses: actions/download-artifact@v4
        with:
          path: downloaded-metrics
          pattern: '*-metrics-*'

      - name: Merge metrics
        run: |
          mkdir -p data/metrics/logs
          find downloaded-metrics -name "*.log" -exec cat {} \; > data/metrics/logs/merged.log

      - name: Generate quality report
        run: |
          echo "## ESPN Data Collection Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          uv run python scripts/dev/espn_metrics_monitor.py --report >> $GITHUB_STEP_SUMMARY || true
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Detect anomalies
        continue-on-error: true
        run: |
          echo "## Anomaly Detection" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          uv run python scripts/dev/espn_metrics_monitor.py --anomalies >> $GITHUB_STEP_SUMMARY || true
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Export metrics CSV
        run: |
          uv run python scripts/dev/espn_metrics_monitor.py --export-csv metrics.csv
          echo "Metrics exported to metrics.csv"

      - name: Upload quality report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: quality-report
          path: |
            metrics.csv
            data/metrics/logs/merged.log
          retention-days: 90

  # ========================================================================
  # Step 4: Commit Results (if successful)
  # ========================================================================
  commit-results:
    name: Commit Results to Repository
    runs-on: ubuntu-latest
    needs: [monitor-quality]
    if: success()
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download quality report
        uses: actions/download-artifact@v4
        with:
          name: quality-report
          path: ./

      - name: Configure git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Commit metrics
        run: |
          git add -A
          git commit -m "chore(data): update ESPN metrics and archived data" || echo "No changes to commit"
          git push || echo "Failed to push (no changes)"
        continue-on-error: true

  # ========================================================================
  # Step 5: Notify on Failure
  # ========================================================================
  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: [collect-ncaaf, collect-nfl, monitor-quality]
    if: failure()
    steps:
      - name: Create issue
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[ALERT] ESPN Data Collection Failed - ${new Date().toISOString().split('T')[0]}`,
              body: `
                ESPN data collection workflow failed.

                **Workflow Run**: https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}

                Please check the logs for details.
              `,
              labels: ['data-collection', 'alert']
            })
